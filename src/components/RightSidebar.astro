---
interface Props {
  headings?: { depth: number; slug: string; text: string }[];
}

const { headings = [] } = Astro.props;
---

<aside class="w-[240px] fixed top-24 bottom-0 right-0 overflow-y-auto hidden xl:block z-30 pr-6">
  <div class="p-6">
    <h5 class="text-[12px] font-bold text-[#5F6368] uppercase tracking-wider mb-4">On this page</h5>
    <ul class="space-y-0 border-l border-[#DADCE0]">
      {headings.map((heading) => (
        <li>
          <a 
            href={`#${heading.slug}`}
            data-slug={heading.slug}
            class:list={[
              "toc-link block py-1.5 pl-4 text-[13px] text-[#5F6368] hover:text-[#202124] border-l border-transparent hover:border-[#9AA0A6] -ml-[1px] transition-colors",
              heading.depth === 3 ? "pl-8" : ""
            ]}
          >
            {heading.text}
          </a>
        </li>
      ))}
    </ul>
  </div>
</aside>

<script>
  // Active Scroll Spy
  const tocLinks = document.querySelectorAll(".toc-link");
  const sections = [];
  
  // Collect all headings and their positions
  document.querySelectorAll(".prose h2, .prose h3").forEach((heading) => {
      if (heading.id) {
          sections.push(heading);
      }
  });

  function onScroll() {
      const scrollPos = window.scrollY + 100; // Offset for sticky header
      
      let current = "";
      for (const section of sections) {
          if (section.offsetTop <= scrollPos) {
              current = section.id;
          }
      }

      // If at bottom, highlight last
      if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 50) {
        if (sections.length > 0) {
            current = sections[sections.length - 1].id;
        }
      }

      updateActiveLink(current);
  }

  function updateActiveLink(id) {
    tocLinks.forEach((link) => {
        link.classList.remove("text-[#202124]", "border-[#202124]", "font-medium");
        link.classList.add("text-[#5F6368]", "border-transparent");
        
        if (link.getAttribute("data-slug") === id) {
            link.classList.remove("text-[#5F6368]", "border-transparent");
            link.classList.add("text-[#202124]", "border-[#202124]", "font-medium");
        }
    });
  }

  // Throttled scroll listener
  let ticking = false;
  window.addEventListener("scroll", () => {
    if (!ticking) {
        window.requestAnimationFrame(() => {
            onScroll();
            ticking = false;
        });
        ticking = true;
    }
  });
  
  // Initial check
  onScroll();
</script>
